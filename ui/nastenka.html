<header>
    <a href="/novy_list"><img class="plus" src="{{@BASE}}/ui/content/plus.png" alt="pridat_icon" ></a>
    <div class="login">
        <check if="{{ @SESSION.isLoggedIn }}">
            <true>
                <a style="text-decoration: none; color: black;"><b>{{@SESSION.user["email"]}}</b></a>
                <a href="/archiv">Archiv</a>
                <a href="/odhlaseni">Odhlásit se</a>
            </true>
            <false>
        <!-- TODO pokud bude session, tak napsat místo toho jméno s možností odhlášení (vymyslet logiku zobrazování) -->
                <a href="/prihlaseni">Přihlásit se</a>
                <a href="/registrace">Registrovat</a>
            </false>
        </check>
    </div>
</header>

<main id="container"></main>

<!-- Template for draggable element -->
<template id="listecekTemplate">
    <div class="listecek">
        <div id="textContent">TEXT</div><br>
        <p id="vytvoreno" style="position: absolute; bottom: -15px;"></p>
        <a id="uprav" ><button style="position: absolute; bottom: 1px; right: 25%;"><i class="fas fa-edit"></i></button></a>
        <button onclick="random_barva(this)" style="position: absolute; bottom: 1px; right: 11%;"><i class="fas fa-paint-brush"></i></button>
        <button onclick="smazat(this)" style="position: absolute; bottom: 1px; right: 1%;"><i class="fas fa-trash-alt"></i></button>
    </div>
</template>

<script src="https://cdn.jsdelivr.net/npm/marked@2.1.3/marked.min.js"></script>
<script>
    function vytvorit_listecek(x,y,z,barva,barva_textu,text,id,cas) {
        // Clone the template
        const template = document.getElementById('listecekTemplate');
        const newElement = template.content.cloneNode(true).firstElementChild;

        newElement.className = 'listecek';
        newElement.draggable = true;
        newElement.id = id;

        newElement.style.backgroundColor = barva;
        newElement.style.color = barva_textu;

        // Set initial position
        newElement.style.left = x;
        newElement.style.top = y;

        newElement.style.zIndex = z;

        const textElement = newElement.querySelector('#textContent');
        textElement.innerHTML = marked(text);
        const upravHref = newElement.querySelector('#uprav');
        upravHref.href = 'upravit/' + id;
        const casElement = newElement.querySelector('#vytvoreno');
        casElement.innerHTML = cas;

        document.getElementById('container').appendChild(newElement);

        let offsetX, offsetY, isDragging = false;

        newElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - newElement.getBoundingClientRect().left;
            offsetY = e.clientY - newElement.getBoundingClientRect().top;
            newElement.style.cursor = 'grabbing';
            newElement.style.zIndex = 3;

            const allNotes = document.querySelectorAll('.listecek');
            allNotes.forEach(note => {
                if (note.id !== newElement.id) {
                    const zIndex = parseInt(note.style.zIndex);
                    if (zIndex !== 1) {
                        note.style.zIndex = zIndex - 1;
                    }
                }
            })

            });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            newElement.style.left = `${x}px`;
            newElement.style.top = `${y}px`;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                newElement.style.cursor = 'grab';

                // Set initial position when mouse is released
                const rect = newElement.getBoundingClientRect();
                newElement.style.left = `${rect.left}px`;
                newElement.style.top = `${rect.top}px`;
                const data = { id: newElement.id, x: rect.left, y: rect.top, z: parseInt(newElement.style.zIndex) }; // Data k odeslání

                console.log(data);

                ajaxRequest("/zmena_pozice", data);
            }
        });
    }

    function getRandomColor() {
        // Generate a random color in hex format
        return '#' + Math.floor(Math.random()*16777215).toString(16);
    }

    function getBrightness(color) {
        // Convert hex color to RGB
        const r = parseInt(color.slice(1, 3), 16);
        const g = parseInt(color.slice(3, 5), 16);
        const b = parseInt(color.slice(5, 7), 16);

        // Calculate brightness using the formula
        return (r * 299 + g * 587 + b * 114) / 1000;
    }

    function random_barva(element) {
        const randomColor = getRandomColor();
        element.parentElement.style.backgroundColor = randomColor;

        // Determine the brightness of the background color
        const brightness = getBrightness(randomColor);

        // Set text color based on brightness
        barva_textu = brightness > 128 ? '#000000' : '#ffffff';
        element.parentElement.style.color = barva_textu;

        // Změna barvy v databázi
        const data = { id: element.parentElement.id, barva: randomColor, barva_textu: barva_textu }; // Data k odeslání
        console.log(data);

        ajaxRequest("/zmena_barvy", data);
    }

    function ajaxRequest(url, data) {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(data));
    }

    function smazat(element) {
        const listecekId = element.parentElement.id; // Získání ID listku
        const data = { id: listecekId}; // Data k odeslání
        console.log(data);

        ajaxRequest("/smazat", data);
        element.parentElement.remove();
    }


</script>

<repeat group="{{@data}}" value="{{@data}}">
    <script>
        vytvorit_listecek("{{@data.x}}px","{{@data.y}}px","{{@data.z}}","{{@data.barva}}","{{@data.barva_textu}}","{{@data.text}}","{{@data.id}}","{{@data.pridano}}")
    </script>
</repeat>

</body>
</html>