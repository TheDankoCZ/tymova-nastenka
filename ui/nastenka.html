<header>
    <a href="/novy_list"><img class="plus" src="{{@BASE}}/ui/content/plus.png" alt="pridat_icon" ></a>
    <div class="login">
        <!-- TODO pokud bude session, tak napsat místo toho jméno s možností odhlášení (vymyslet logiku zobrazování) -->
        <a href="login.html" id="loginLink">Přihlásit se</a>
        <a href="register.html">Registrovat</a>
    </div>
</header>

<main id="container"></main>

<!-- Template for draggable element -->
<template id="listecekTemplate">
    <div class="listecek">
        <a id="uprav"><button>Upravit</button></a>
        <!-- <button onclick="random_barva(this)">barva</button> -->
        <br>
        <p id="textContent">TEXT</p>
    </div>
</template>


<script>
    function createDraggableElement(x,y,barva,barva_textu,text,id) {
        // Clone the template
        const template = document.getElementById('listecekTemplate');
        const newElement = template.content.cloneNode(true).firstElementChild;

        newElement.className = 'listecek';
        newElement.draggable = true;
        newElement.id = id;

        newElement.style.backgroundColor = barva;
        newElement.style.color = barva_textu;

        // Set initial position
        newElement.style.left = x;
        newElement.style.top = y;

        const textElement = newElement.querySelector('#textContent');
        textElement.textContent = text;
        const upravHref = newElement.querySelector('#uprav');
        upravHref.href = 'upravit/' + id;

        document.getElementById('container').appendChild(newElement);

        let offsetX, offsetY, isDragging = false;

        newElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - newElement.getBoundingClientRect().left;
            offsetY = e.clientY - newElement.getBoundingClientRect().top;
            newElement.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            newElement.style.left = `${x}px`;
            newElement.style.top = `${y}px`;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                newElement.style.cursor = 'grab';

                // Set initial position when mouse is released
                const rect = newElement.getBoundingClientRect();
                newElement.style.left = `${rect.left}px`;
                newElement.style.top = `${rect.top}px`;
                const data = { id: newElement.id, x: rect.left, y: rect.top }; // Data k odeslání
                console.log(data);

                ajaxRequest("/zmena_pozice", data);
            }
        });
    }

    function getRandomColor() {
        // Generate a random color in hex format
        return '#' + Math.floor(Math.random()*16777215).toString(16);
    }

    function getBrightness(color) {
        // Convert hex color to RGB
        const r = parseInt(color.slice(1, 3), 16);
        const g = parseInt(color.slice(3, 5), 16);
        const b = parseInt(color.slice(5, 7), 16);

        // Calculate brightness using the formula
        return (r * 299 + g * 587 + b * 114) / 1000;
    }

    function random_barva(element) {
        const randomColor = getRandomColor();
        element.parentElement.style.backgroundColor = randomColor;

        // Determine the brightness of the background color
        const brightness = getBrightness(randomColor);

        // Set text color based on brightness
        barva_textu = brightness > 128 ? '#000000' : '#ffffff';
        element.parentElement.style.color = barva_textu;

        // Změna barvy v databázi
        const data = { id: element.parentElement.id, barva: randomColor, barva_textu: barva_textu }; // Data k odeslání
        console.log(data);

        ajaxRequest("/zmena_barvy", data);
    }

    function ajaxRequest(url, data) {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(data));
    }

</script>

<repeat group="{{@data}}" value="{{@data}}">
    <script>
        createDraggableElement("{{@data.x}}px","{{@data.y}}px","{{@data.barva}}","{{@data.barva_textu}}","{{@data.text}}","{{@data.id}}")
    </script>
</repeat>

</body>
</html>