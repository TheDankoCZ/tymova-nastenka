<header>
    <a href="/novy_list"><img class="plus" src="{{@BASE}}/ui/content/plus.png" alt="pridat_icon" ></a>
    <div class="login">
        <!-- TODO pokud bude session, tak napsat místo toho jméno s možností odhlášení (vymyslet logiku zobrazování) -->
        <a href="login.html" id="loginLink">Přihlásit se</a>
        <a href="register.html">Registrovat</a>
    </div>
</header>

<main id="container"></main>

<!-- Template for draggable element -->
<template id="listecekTemplate">
    <div class="listecek">
        <a id="uprav"><button>Upravit</button></a>
        <br>
        <p id="textContent">TEXT</p>
    </div>
</template>


<script>
    function createDraggableElement(x,y,barva,text,id) {
        // Clone the template
        const template = document.getElementById('listecekTemplate');
        const newElement = template.content.cloneNode(true).firstElementChild;

        newElement.className = 'listecek';
        newElement.draggable = true;
        newElement.id = id;

        newElement.style.backgroundColor = barva;

        // Set initial position
        newElement.style.left = x;
        newElement.style.top = y;

        const textElement = newElement.querySelector('#textContent');
        textElement.textContent = text;
        const upravHref = newElement.querySelector('#uprav');
        upravHref.href = 'upravit/' + id;

        document.getElementById('container').appendChild(newElement);

        let offsetX, offsetY, isDragging = false;

        newElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - newElement.getBoundingClientRect().left;
            offsetY = e.clientY - newElement.getBoundingClientRect().top;
            newElement.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            newElement.style.left = `${x}px`;
            newElement.style.top = `${y}px`;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                newElement.style.cursor = 'grab';

                // Set initial position when mouse is released
                const rect = newElement.getBoundingClientRect();
                newElement.style.left = `${rect.left}px`;
                newElement.style.top = `${rect.top}px`;
                const data = { id: newElement.id, x: rect.left, y: rect.top }; // Data k odeslání

                console.log(data);

                // Vytvoření AJAX požadavku
                const xhr = new XMLHttpRequest();
                xhr.open("POST", "/zmena_pozice", true); // Nastavení adresy backendu
                xhr.setRequestHeader("Content-Type", "application/json");

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Úspěšná odezva z backendu
                            console.log("Data byla úspěšně odeslána na server.");
                        } else {
                            // Chyba při komunikaci s backendem
                            console.error("Došlo k chybě při odesílání dat na server.");
                        }
                    }
                };

                // Odeslání dat na server ve formátu JSON
                xhr.send(JSON.stringify(data));
            }
        });
    }

</script>

<repeat group="{{@data}}" value="{{@data}}">
    <script>
        createDraggableElement("{{@data.x}}px","{{@data.y}}px","{{@data.barva}}","{{@data.text}}","{{@data.id}}")
    </script>
</repeat>

</body>
</html>